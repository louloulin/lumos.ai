name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬ (ä¾‹å¦‚: 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  # éªŒè¯å‘å¸ƒæ¡ä»¶
  validate:
    name: éªŒè¯å‘å¸ƒæ¡ä»¶
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ç¡®å®šç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG="v${VERSION}"
          else
            TAG="${{ github.ref_name }}"
            VERSION="${TAG#v}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "å‘å¸ƒç‰ˆæœ¬: ${VERSION}"
          echo "å‘å¸ƒæ ‡ç­¾: ${TAG}"

      - name: éªŒè¯ç‰ˆæœ¬æ ¼å¼
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬æ ¼å¼: $VERSION"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬æ ¼å¼æœ‰æ•ˆ: $VERSION"

  # è¿è¡Œå®Œæ•´çš„ CI æ£€æŸ¥
  ci:
    name: CI æ£€æŸ¥
    uses: ./.github/workflows/ci.yml
    needs: validate

  # æž„å»ºå‘å¸ƒäº§ç‰©
  build:
    name: æž„å»ºå‘å¸ƒäº§ç‰©
    runs-on: ${{ matrix.os }}
    needs: [validate, ci]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: lumosai-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: lumosai-windows-x64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: lumosai-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: lumosai-macos-arm64

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          target: ${{ matrix.target }}

      - name: æž„å»ºå‘å¸ƒç‰ˆæœ¬
        run: cargo build --release --target ${{ matrix.target }} --all-features

      - name: åˆ›å»ºå‘å¸ƒåŒ…
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TARGET="${{ matrix.target }}"
          ARTIFACT_NAME="${{ matrix.artifact_name }}"
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p "release/${ARTIFACT_NAME}"
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp "target/${TARGET}/release/lumosai.exe" "release/${ARTIFACT_NAME}/"
            cp "target/${TARGET}/release/lumosai_cli.exe" "release/${ARTIFACT_NAME}/" || true
          else
            cp "target/${TARGET}/release/lumosai" "release/${ARTIFACT_NAME}/"
            cp "target/${TARGET}/release/lumosai_cli" "release/${ARTIFACT_NAME}/" || true
          fi
          
          # å¤åˆ¶æ–‡æ¡£å’Œè®¸å¯è¯
          cp README.md "release/${ARTIFACT_NAME}/"
          cp LICENSE "release/${ARTIFACT_NAME}/" || echo "MIT" > "release/${ARTIFACT_NAME}/LICENSE"
          cp CHANGELOG.md "release/${ARTIFACT_NAME}/" || echo "# Changelog" > "release/${ARTIFACT_NAME}/CHANGELOG.md"
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          cd release
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            7z a "${ARTIFACT_NAME}-${VERSION}.zip" "${ARTIFACT_NAME}/"
          else
            tar -czf "${ARTIFACT_NAME}-${VERSION}.tar.gz" "${ARTIFACT_NAME}/"
          fi

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}-${{ needs.validate.outputs.version }}
          path: release/${{ matrix.artifact_name }}-${{ needs.validate.outputs.version }}.*

  # å‘å¸ƒåˆ° crates.io
  publish-crates:
    name: å‘å¸ƒåˆ° crates.io
    runs-on: ubuntu-latest
    needs: [validate, ci]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: ç™»å½• crates.io
        run: cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: å‘å¸ƒåŒ…
        run: |
          # æŒ‰ä¾èµ–é¡ºåºå‘å¸ƒåŒ…
          PACKAGES=(
            "lumos_macro"
            "lumosai_core"
            "lumosai_vector/core"
            "lumosai_vector"
            "lumosai_evals"
            "lumosai_rag"
            "lumosai_network"
            "lumosai_cli"
            "."
          )
          
          for package in "${PACKAGES[@]}"; do
            echo "ðŸ“¦ å‘å¸ƒåŒ…: $package"
            if [ "$package" = "." ]; then
              cargo publish --allow-dirty || echo "âš ï¸ å‘å¸ƒå¤±è´¥æˆ–å·²å­˜åœ¨: $package"
            else
              cargo publish --package "$(basename "$package")" --allow-dirty || echo "âš ï¸ å‘å¸ƒå¤±è´¥æˆ–å·²å­˜åœ¨: $package"
            fi
            
            # ç­‰å¾… crates.io å¤„ç†
            sleep 30
          done

  # åˆ›å»º GitHub Release
  github-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, ci, build]
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        id: release_notes
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"
          
          # èŽ·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
          cat > release_notes.md << EOF
          # LumosAI ${VERSION}
          
          ## ðŸš€ æ–°åŠŸèƒ½å’Œæ”¹è¿›
          
          EOF
          
          if [ -n "$LAST_TAG" ]; then
            echo "## ðŸ“ å˜æ›´è®°å½• (è‡ª $LAST_TAG)" >> release_notes.md
            echo "" >> release_notes.md
            git log --oneline "$LAST_TAG"..HEAD | sed 's/^/- /' >> release_notes.md
          else
            echo "## ðŸ“ å˜æ›´è®°å½•" >> release_notes.md
            echo "" >> release_notes.md
            echo "- åˆå§‹å‘å¸ƒ" >> release_notes.md
          fi
          
          cat >> release_notes.md << EOF
          
          ## ðŸ“¦ å®‰è£…æ–¹å¼
          
          ### Cargo
          \`\`\`bash
          cargo install lumosai
          \`\`\`
          
          ### äºŒè¿›åˆ¶ä¸‹è½½
          ä»Žä¸‹æ–¹çš„ Assets ä¸­ä¸‹è½½é€‚åˆæ‚¨å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚
          
          ## ðŸ”— ç›¸å…³é“¾æŽ¥
          
          - [æ–‡æ¡£](https://docs.rs/lumosai)
          - [ç¤ºä¾‹](https://github.com/lumosai/lumosai/tree/main/examples)
          - [å˜æ›´æ—¥å¿—](https://github.com/lumosai/lumosai/blob/main/CHANGELOG.md)
          
          EOF

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: LumosAI ${{ needs.validate.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            artifacts/**/*

  # æ›´æ–°æ–‡æ¡£
  update-docs:
    name: æ›´æ–°æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [validate, ci]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: æž„å»ºæ–‡æ¡£
        run: cargo doc --all-features --workspace --no-deps

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          destination_dir: docs/${{ needs.validate.outputs.version }}

  # é€šçŸ¥
  notify:
    name: å‘å¸ƒé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [validate, github-release, publish-crates, update-docs]
    if: always()
    steps:
      - name: å‘é€é€šçŸ¥
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"
          
          if [[ "${{ needs.github-release.result }}" == "success" ]]; then
            echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ: $TAG"
          else
            echo "âŒ GitHub Release åˆ›å»ºå¤±è´¥"
          fi
          
          if [[ "${{ needs.publish-crates.result }}" == "success" ]]; then
            echo "âœ… crates.io å‘å¸ƒæˆåŠŸ"
          else
            echo "âš ï¸ crates.io å‘å¸ƒè·³è¿‡æˆ–å¤±è´¥"
          fi
          
          if [[ "${{ needs.update-docs.result }}" == "success" ]]; then
            echo "âœ… æ–‡æ¡£æ›´æ–°æˆåŠŸ"
          else
            echo "âš ï¸ æ–‡æ¡£æ›´æ–°è·³è¿‡æˆ–å¤±è´¥"
          fi
          
          echo "ðŸŽ‰ LumosAI $VERSION å‘å¸ƒå®Œæˆï¼"
