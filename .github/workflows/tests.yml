name: ğŸ§ª Test Suite

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Code quality checks
  quality:
    name: ğŸ“‹ Code Quality
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        components: rustfmt, clippy
        override: true

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ¨ Check formatting
      run: cargo fmt --all -- --check

    - name: ğŸ“ Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings

    - name: ğŸ” Check documentation
      run: cargo doc --no-deps --document-private-items

  # Unit tests
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, beta]
        exclude:
          # Reduce CI load by excluding some combinations
          - os: windows-latest
            rust: beta
          - os: macos-latest
            rust: beta
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ matrix.rust }}
        override: true

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-${{ matrix.rust }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ”¨ Build
      run: cargo build --verbose

    - name: ğŸ§ª Run unit tests
      run: cargo test --lib --verbose
      timeout-minutes: 10

    - name: ğŸ§ª Run documentation tests
      run: cargo test --doc --verbose
      timeout-minutes: 5

  # Integration tests
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [quality, unit-tests]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ”— Run integration tests
      run: cargo test --tests integration --verbose
      timeout-minutes: 15

  # Example validation
  examples:
    name: ğŸ’¡ Example Validation
    runs-on: ubuntu-latest
    needs: [quality]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ’¡ Validate examples
      run: |
        examples=(
          "basic_agent"
          "rag_system"
          "tool_integration"
          "memory_system"
          "vector_storage"
          "streaming_response"
          "multi_agent_workflow"
          "enhanced_features_demo"
          "performance_benchmark"
          "auth_demo"
          "monitoring_demo_simple"
          "simplified_api_complete_demo"
        )
        
        failed=0
        total=${#examples[@]}
        
        for example in "${examples[@]}"; do
          echo "ğŸ” Validating example: $example"
          if timeout 60 cargo run --example "$example" > /dev/null 2>&1; then
            echo "âœ… Example $example passed"
          else
            echo "âŒ Example $example failed"
            ((failed++))
          fi
        done
        
        echo "ğŸ“Š Example validation summary: $((total - failed))/$total passed"
        
        if [ $failed -gt 0 ]; then
          echo "âŒ $failed examples failed"
          exit 1
        else
          echo "âœ… All examples passed"
        fi
      timeout-minutes: 20

  # Performance tests
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: âš¡ Run performance tests
      run: cargo test --tests performance --release --verbose
      timeout-minutes: 30

  # Coverage
  coverage:
    name: ğŸ“Š Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: ğŸ“¦ Install tarpaulin
      run: cargo install cargo-tarpaulin

    - name: ğŸ“Š Generate coverage
      run: |
        cargo tarpaulin --verbose --all-features --workspace --timeout 600 \
          --exclude-files "examples/*" "tests/*" "benches/*" \
          --out Xml --out Html
      timeout-minutes: 20

    - name: ğŸ“¤ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./cobertura.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: ğŸ“Š Coverage comment
      if: github.event_name == 'pull_request'
      run: |
        coverage=$(grep -o 'line-rate="[^"]*"' cobertura.xml | head -1 | grep -o '[0-9.]*')
        coverage_percent=$(echo "$coverage * 100" | bc -l | cut -d. -f1)
        
        echo "ğŸ“Š Coverage: ${coverage_percent}%"
        
        if [ "$coverage_percent" -ge 80 ]; then
          echo "âœ… Coverage meets threshold (â‰¥80%)"
        else
          echo "âš ï¸ Coverage below threshold (<80%)"
        fi

  # Security audit
  security:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: ğŸ›¡ï¸ Install cargo-audit
      run: cargo install cargo-audit

    - name: ğŸ” Run security audit
      run: cargo audit

  # Final status check
  test-status:
    name: âœ… Test Status
    runs-on: ubuntu-latest
    needs: [quality, unit-tests, integration-tests, examples, performance, coverage, security]
    if: always()
    
    steps:
    - name: âœ… All tests passed
      if: ${{ needs.quality.result == 'success' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' && needs.examples.result == 'success' && needs.performance.result == 'success' && needs.coverage.result == 'success' && needs.security.result == 'success' }}
      run: |
        echo "ğŸ‰ All tests passed successfully!"
        echo "âœ… Quality checks: passed"
        echo "âœ… Unit tests: passed"
        echo "âœ… Integration tests: passed"
        echo "âœ… Examples: passed"
        echo "âœ… Performance tests: passed"
        echo "âœ… Coverage: passed"
        echo "âœ… Security audit: passed"

    - name: âŒ Some tests failed
      if: ${{ needs.quality.result != 'success' || needs.unit-tests.result != 'success' || needs.integration-tests.result != 'success' || needs.examples.result != 'success' || needs.performance.result != 'success' || needs.coverage.result != 'success' || needs.security.result != 'success' }}
      run: |
        echo "âŒ Some tests failed:"
        echo "Quality checks: ${{ needs.quality.result }}"
        echo "Unit tests: ${{ needs.unit-tests.result }}"
        echo "Integration tests: ${{ needs.integration-tests.result }}"
        echo "Examples: ${{ needs.examples.result }}"
        echo "Performance tests: ${{ needs.performance.result }}"
        echo "Coverage: ${{ needs.coverage.result }}"
        echo "Security audit: ${{ needs.security.result }}"
        exit 1
