# Lumosai CLI 开发文档

本文档详细介绍了 Lumosai CLI 工具的功能、实现和测试情况。

## 1. 概览

Lumosai CLI 是一个命令行工具，用于创建、开发、运行和部署 Lumosai AI 应用。它提供了一套完整的工具链，帮助开发者更高效地构建基于 Lumosai 框架的 AI 应用。

## 2. 功能实现

### 2.1 Create 命令

Create 命令用于创建新的 Lumosai 项目，实现文件位于 `lumosai_cli/src/commands/create.rs`。

#### 功能特性：
- 交互式选择项目名称
- 选择组件（agents, tools, workflows, RAG）
- 选择 LLM 提供商（openai, anthropic, gemini, local）
- 配置 API 密钥
- 创建基本项目结构
- 初始化 Git 仓库
- 安装依赖

### 2.2 UI 命令

UI 命令用于启动 Lumosai Web UI，实现文件位于 `lumosai_cli/src/commands/ui.rs` 和 `lumosai_cli/src/server/ui_server.rs`。

#### 功能特性：
- 配置服务器端口
- 主题选择（light/dark）
- 开发模式配置
- API 服务器 URL 指定
- 自动查找 UI 服务器路径
- 开发模式与生产模式无缝切换
- 环境变量自动配置
- 自动打开浏览器
- 自动检测并使用可用端口
- 优雅的中断处理（Ctrl+C）

#### 实现细节：
- **服务器配置**：通过 `UiServerConfig` 结构体管理所有服务器设置，包括端口、主题、模式和API URL等。
- **开发模式**：在开发模式下，使用 npm 或 pnpm 启动开发服务器，支持热重载和实时编译。
- **生产模式**：在生产模式下，使用 actix-web 提供编译后的静态资源，性能更优。
- **自动发现**：智能查找UI资源目录，支持从环境变量、相对路径或标准安装位置获取。
- **SPA 支持**：所有前端路由都正确转发到 index.html，确保单页应用的正常工作。

### 2.3 Playground 命令

Playground 命令用于启动交互式测试环境，实现文件位于 `lumosai_cli/src/commands/playground.rs`。

#### 功能特性：
- 配置测试环境端口
- 指定要测试的代理
- 保存对话历史
- 自定义 API URL
- 自动查找测试环境路径

### 2.4 API 命令

API 命令用于生成 API 端点，实现文件位于 `lumosai_cli/src/commands/api.rs` 和 `lumosai_cli/src/server/api_server.rs`。

#### 功能特性：
- 自动扫描项目中的代理
- 生成标准 RESTful API
- 选择性生成特定代理的 API
- 自定义输出目录

### 2.5 Dev 命令

Dev 命令用于启动开发服务器，实现文件位于 `lumosai_cli/src/commands/dev.rs`。

#### 功能特性：
- 启动 API 服务器
- 可选启动 UI 服务器
- 文件监视和自动重载
- 自定义工具目录
- 配置 UI 主题和端口

### 2.6 Visualize 命令

Visualize 命令用于生成代理和工作流的可视化图表，实现文件位于 `lumosai_cli/src/commands/visualize.rs`。

#### 功能特性：
- 生成代理结构可视化
- 生成工作流可视化
- 支持多种导出格式（PNG, SVG, PDF, HTML）
- 交互式 HTML 可视化
- 性能数据集成
- 自动解析代理和工作流代码

## 3. 架构设计

### 3.1 服务器模块

服务器模块位于 `lumosai_cli/src/server` 目录，提供了核心服务功能：

- **UI 服务器**：负责提供 Web UI 界面，支持开发模式和生产模式。
- **API 服务器**：提供 API 服务，支持代理 API 的自动生成和代理。
- **文件监视**：监视文件变更，支持自动重载。

### 3.2 命令模块

命令模块位于 `lumosai_cli/src/commands` 目录，每个命令独立实现：

- 使用 clap 进行命令行参数解析
- 支持异步操作
- 友好的错误处理
- 清晰的彩色终端输出

### 3.3 工具模块

工具模块位于 `lumosai_cli/src/util.rs`，提供通用工具函数：

- 项目目录查找
- 命令可用性检查
- 端口管理
- 文件操作

### 3.4 错误处理

错误处理模块位于 `lumosai_cli/src/error.rs`，提供统一的错误类型：

- IO 错误
- 路径未找到
- 依赖项缺失
- 服务器错误
- 内部错误

## 4. 测试

### 4.1 单元测试

为每个命令编写了单元测试，测试内容包括：

#### UI 命令测试
- 环境变量路径获取
- 无效目录处理
- 默认值配置

#### Playground 命令测试
- 环境变量路径获取
- 无效目录处理
- 无效代理处理
- 默认值配置

#### API 命令测试
- 无效目录处理
- 空代理集测试
- 无效代理名测试
- 代理查找功能测试

#### Create 命令测试
- 选项处理
- Cargo.toml 生成
- 基本项目结构测试
- 代理文件生成
- 示例文件生成

#### Dev 命令测试
- 默认选项测试
- 自定义选项测试
- 无效目录处理
- 项目结构创建测试

#### Visualize 命令测试
- 格式验证
- 函数名提取
- Use 语句解析
- 项目结构测试

### 4.2 集成测试

测试主要命令的端到端功能，包括：

- 创建新项目
- 启动开发服务器
- 生成 API 端点
- 可视化代理结构

## 5. 依赖项

主要使用的外部库包括：

- **clap**: 命令行参数解析
- **tokio**: 异步运行时
- **colored**: 终端彩色输出
- **actix-web**: API 服务器
- **actix-files**: 静态文件服务
- **notify**: 文件监视
- **dialoguer**: 交互式命令行对话
- **rand**: 随机数生成
- **open**: 打开 URL

## 6. 未来工作

### 6.1 功能扩展

- 增强错误处理
- 添加更多项目模板
- 扩展测试环境功能，支持多代理测试
- 增强 API 生成，支持认证和限速
- 添加更多集成测试

### 6.2 性能优化

- 优化开发服务器启动时间
- 减少内存使用
- 增强文件监视效率

### 6.3 文档完善

- 添加更多示例
- 改进命令行帮助信息
- 提供更详细的错误信息和解决方案

## 7. UI功能实现摘要

### 7.1 Web界面架构

Lumosai UI采用了现代前端技术栈，主要包括：

- **React**：用于UI组件构建
- **React Router**：处理前端路由
- **Tailwind CSS**：提供样式系统
- **Shadcn UI**：提供一致性的UI组件库

整体架构遵循了领域驱动设计的理念，将功能按照不同领域进行拆分：

- `/components`：通用UI组件
- `/domains`：特定领域的组件和逻辑
- `/hooks`：自定义React Hooks
- `/lib`：工具函数和帮助方法
- `/services`：API服务和数据访问

### 7.2 核心功能模块

#### 7.2.1 代理管理

代理管理功能位于`/domains/agents`目录，主要功能包括：

- 代理列表展示
- 代理创建和编辑
- 代理详情查看
- 与代理对话交互
- 代理配置管理

#### 7.2.2 知识库管理

知识库管理功能位于`/domains/knowledge`目录，主要功能包括：

- 文档上传和管理
- 向量数据库集成
- 文档检索和查询
- 知识库性能监控

#### 7.2.3 工作流管理

工作流管理功能位于`/domains/workflows`目录，主要功能包括：

- 可视化工作流编辑器
- 工作流步骤定义
- 工作流执行监控
- 工作流调试工具

### 7.3 服务器集成

UI服务器与后端API服务器紧密集成，主要通过以下方式：

- REST API通信
- 环境变量配置
- 服务发现机制
- 统一的错误处理
- 认证和授权

通过CLI工具提供的`ui`命令，用户可以轻松启动UI服务器，并与API服务器进行集成，提供完整的用户体验。 